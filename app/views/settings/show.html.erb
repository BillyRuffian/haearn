<% content_for :title, "Settings" %>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <h1 class="mb-4">
        <i class="bi bi-gear-fill me-2 text-rust"></i>
        Settings
      </h1>

      <!-- Profile Settings -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-person-fill me-2"></i>
            Profile
          </h5>
        </div>
        <div class="card-body">
          <%= form_with model: @user, url: settings_path, method: :patch do |form| %>
            <% if @user.errors.any? && !@user.errors[:current_password].any? && !@user.errors[:password].any? %>
              <div class="alert alert-danger">
                <ul class="mb-0">
                  <% @user.errors.full_messages.each do |message| %>
                    <% next if message.include?('Password') || message.include?('Current password') %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <div class="mb-3">
              <%= form.label :name, class: "form-label" %>
              <%= form.text_field :name, class: "form-control #{'is-invalid' if @user.errors[:name].any?}", autofocus: true %>
              <% if @user.errors[:name].any? %>
                <div class="invalid-feedback"><%= @user.errors[:name].first %></div>
              <% end %>
            </div>

            <div class="mb-3">
              <%= form.label :email_address, "Email", class: "form-label" %>
              <%= form.email_field :email_address, class: "form-control #{'is-invalid' if @user.errors[:email_address].any?}" %>
              <% if @user.errors[:email_address].any? %>
                <div class="invalid-feedback"><%= @user.errors[:email_address].first %></div>
              <% end %>
            </div>

            <div class="text-end">
              <%= form.submit "Save Profile", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Preferences -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-sliders me-2"></i>
            Preferences
          </h5>
        </div>
        <div class="card-body">
          <%= form_with model: @user, url: settings_path, method: :patch, data: { controller: "settings-form" } do |form| %>
            <div class="mb-4">
              <%= form.label :preferred_unit, "Weight Unit", class: "form-label" %>
              <div class="btn-group w-100" role="group">
                <% User::UNITS.each do |unit| %>
                  <input type="radio" class="btn-check" name="user[preferred_unit]" 
                         id="unit_<%= unit %>" value="<%= unit %>" 
                         <%= 'checked' if @user.preferred_unit == unit %>>
                  <label class="btn btn-outline-primary" for="unit_<%= unit %>">
                    <%= unit.upcase %>
                    <span class="text-muted small">(<%= unit == 'kg' ? 'Kilograms' : 'Pounds' %>)</span>
                  </label>
                <% end %>
              </div>
              <div class="form-text">Weights will be displayed in your preferred unit</div>
            </div>

            <div class="mb-4" data-controller="rest-slider">
              <%= form.label :default_rest_seconds, "Default Rest Timer", class: "form-label" %>
              <div class="d-flex align-items-center gap-3">
                <input type="range" 
                       class="form-range flex-grow-1" 
                       name="user[default_rest_seconds]" 
                       id="user_default_rest_seconds"
                       min="<%= User::MIN_REST_SECONDS %>" 
                       max="<%= User::MAX_REST_SECONDS %>" 
                       step="15"
                       value="<%= @user.default_rest_seconds %>"
                       data-rest-slider-target="slider"
                       data-action="input->rest-slider#updateDisplay">
                <span class="rest-timer-display badge bg-primary fs-5" 
                      data-rest-slider-target="display"
                      style="min-width: 80px;">
                  <%= format_seconds(@user.default_rest_seconds) %>
                </span>
              </div>
              <div class="d-flex justify-content-between text-muted small mt-1">
                <span><%= format_seconds(User::MIN_REST_SECONDS) %></span>
                <span><%= format_seconds(User::MAX_REST_SECONDS) %></span>
              </div>
              <div class="form-text">Default rest time between sets (new workout blocks will use this)</div>
            </div>

            <div class="text-end">
              <%= form.submit "Save Preferences", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Notifications -->
      <div class="card mb-4" data-controller="notification-permission">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-bell-fill me-2"></i>
            Notifications
          </h5>
          <span data-notification-permission-target="status" class="badge bg-secondary">Checking...</span>
        </div>
        <div class="card-body" data-notification-permission-target="container">
          <p class="text-muted mb-3">
            Get notified when your rest timer completes, even if you've switched to another app.
          </p>
          <button type="button" 
                  class="btn btn-primary"
                  data-notification-permission-target="button"
                  data-action="click->notification-permission#requestPermission">
            Enable Notifications
          </button>
          <div class="form-text mt-2">
            <i class="bi bi-info-circle me-1"></i>
            Notifications only appear when the app is in the background
          </div>
        </div>
      </div>

      <!-- Change Password -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-lock-fill me-2"></i>
            Change Password
          </h5>
        </div>
        <div class="card-body">
          <%= form_with url: update_password_settings_path, method: :patch do |form| %>
            <% if @user.errors[:current_password].any? || @user.errors[:password].any? || @user.errors[:password_confirmation].any? %>
              <div class="alert alert-danger">
                <ul class="mb-0">
                  <% @user.errors[:current_password].each do |msg| %>
                    <li>Current password <%= msg %></li>
                  <% end %>
                  <% @user.errors[:password].each do |msg| %>
                    <li>Password <%= msg %></li>
                  <% end %>
                  <% @user.errors[:password_confirmation].each do |msg| %>
                    <li>Password confirmation <%= msg %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <div class="mb-3">
              <%= form.label :current_password, class: "form-label" %>
              <%= form.password_field :current_password, class: "form-control #{'is-invalid' if @user.errors[:current_password].any?}", autocomplete: "current-password" %>
              <% if @user.errors[:current_password].any? %>
                <div class="invalid-feedback"><%= @user.errors[:current_password].first %></div>
              <% end %>
            </div>

            <div class="mb-3">
              <%= form.label :password, "New Password", class: "form-label" %>
              <%= form.password_field :password, class: "form-control #{'is-invalid' if @user.errors[:password].any?}", autocomplete: "new-password" %>
              <% if @user.errors[:password].any? %>
                <div class="invalid-feedback"><%= @user.errors[:password].first %></div>
              <% end %>
            </div>

            <div class="mb-3">
              <%= form.label :password_confirmation, "Confirm New Password", class: "form-label" %>
              <%= form.password_field :password_confirmation, class: "form-control #{'is-invalid' if @user.errors[:password_confirmation].any?}", autocomplete: "new-password" %>
              <% if @user.errors[:password_confirmation].any? %>
                <div class="invalid-feedback"><%= @user.errors[:password_confirmation].first %></div>
              <% end %>
            </div>

            <div class="text-end">
              <%= form.submit "Change Password", class: "btn btn-warning" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Data Export -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-download me-2"></i>
            Data Export
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            Download your workout data. JSON includes all your data (gyms, machines, exercises, workouts). 
            CSV is a spreadsheet-friendly format for analyzing your training history.
          </p>
          <div class="d-flex gap-2 flex-wrap">
            <%= link_to export_data_settings_path, class: "btn btn-outline-primary" do %>
              <i class="bi bi-filetype-json me-1"></i> Export JSON
            <% end %>
            <%= link_to export_csv_settings_path, class: "btn btn-outline-primary" do %>
              <i class="bi bi-filetype-csv me-1"></i> Export Workouts CSV
            <% end %>
            <%= link_to export_prs_settings_path, class: "btn btn-outline-primary" do %>
              <i class="bi bi-trophy me-1"></i> Export PRs CSV
            <% end %>
          </div>
        </div>
      </div>

      <!-- Sign Out -->
      <div class="card border-danger">
        <div class="card-header bg-danger bg-opacity-10">
          <h5 class="mb-0 text-danger">
            <i class="bi bi-box-arrow-right me-2"></i>
            Sign Out
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">Sign out of your account on this device.</p>
          <%= button_to "Sign Out", session_path, method: :delete, class: "btn btn-outline-danger" %>
        </div>
      </div>
    </div>
  </div>
</div>
