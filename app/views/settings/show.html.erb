<% content_for(:title) { "Settings | Haearn" } %>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <h1 class="display-heading mb-4">
        <i class="bi bi-gear-fill me-2 text-rust"></i>
        Settings
      </h1>

      <!-- Quick Links (Mobile Only) -->
      <div class="card mb-4 d-lg-none">
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <%= link_to gyms_path, class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center" do %>
              <div>
                <i class="bi bi-building me-2"></i>
                <strong>Gyms & Equipment</strong>
                <p class="text-muted small mb-0">Manage your gyms and machines</p>
              </div>
              <i class="bi bi-chevron-right"></i>
            <% end %>
            <%= link_to workout_templates_path, class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center" do %>
              <div>
                <i class="bi bi-journal-bookmark me-2"></i>
                <strong>Workout Templates</strong>
                <p class="text-muted small mb-0">Pre-built workout routines</p>
              </div>
              <i class="bi bi-chevron-right"></i>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="section-header mb-2">
        <i class="bi bi-person-fill me-1"></i> Profile
      </div>
      <div class="card mb-4">
        <div class="card-body">
          <%= form_with model: @user, url: settings_path, method: :patch do |form| %>
            <% if @user.errors.any? && !@user.errors[:current_password].any? && !@user.errors[:password].any? %>
              <div class="alert alert-danger">
                <ul class="mb-0">
                  <% @user.errors.full_messages.each do |message| %>
                    <% next if message.include?('Password') || message.include?('Current password') %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <div class="mb-3">
              <%= form.label :name, class: "form-label" %>
              <%= form.text_field :name, class: "form-control #{'is-invalid' if @user.errors[:name].any?}", autofocus: true %>
              <% if @user.errors[:name].any? %>
                <div class="invalid-feedback"><%= @user.errors[:name].first %></div>
              <% end %>
            </div>

            <div class="mb-3">
              <%= form.label :email_address, "Email", class: "form-label" %>
              <%= form.email_field :email_address, class: "form-control #{'is-invalid' if @user.errors[:email_address].any?}" %>
              <% if @user.errors[:email_address].any? %>
                <div class="invalid-feedback"><%= @user.errors[:email_address].first %></div>
              <% end %>
            </div>

            <div class="text-end">
              <%= form.submit "Save Profile", class: "btn btn-primary btn-sm" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Preferences -->
      <div class="section-header mb-2">
        <i class="bi bi-sliders me-1"></i> Preferences
      </div>
      <div class="card mb-4">
        <div class="card-body">
          <%= form_with model: @user, url: settings_path, method: :patch, data: { controller: "settings-form" } do |form| %>
            <div class="mb-4">
              <%= form.label :preferred_unit, "Weight Unit", class: "form-label" %>
              <div class="btn-group w-100" role="group">
                <% User::UNITS.each do |unit| %>
                  <input type="radio" class="btn-check" name="user[preferred_unit]" 
                         id="unit_<%= unit %>" value="<%= unit %>" 
                         <%= 'checked' if @user.preferred_unit == unit %>>
                  <label class="btn btn-outline-primary" for="unit_<%= unit %>">
                    <%= unit.upcase %>
                    <span class="text-muted small">(<%= unit == 'kg' ? 'Kilograms' : 'Pounds' %>)</span>
                  </label>
                <% end %>
              </div>
              <div class="form-text">Weights will be displayed in your preferred unit</div>
            </div>

            <div class="mb-4">
              <%= form.label :default_gym_id, "Default Gym", class: "form-label" %>
              <%= form.select :default_gym_id, 
                    @user.gyms.order(:name).map { |g| [g.name, g.id] },
                    { include_blank: "— None —", selected: @user.default_gym_id },
                    class: "form-select" %>
              <div class="form-text">Auto-selected when starting a new workout</div>
            </div>

            <div class="mb-4" data-controller="rest-slider">
              <%= form.label :default_rest_seconds, "Default Rest Timer", class: "form-label" %>
              <div class="d-flex align-items-center gap-3">
                <input type="range" 
                       class="form-range flex-grow-1" 
                       name="user[default_rest_seconds]" 
                       id="user_default_rest_seconds"
                       min="<%= User::MIN_REST_SECONDS %>" 
                       max="<%= User::MAX_REST_SECONDS %>" 
                       step="15"
                       value="<%= @user.default_rest_seconds %>"
                       data-rest-slider-target="slider"
                       data-action="input->rest-slider#updateDisplay">
                <span class="rest-timer-display badge bg-primary fs-5" 
                      data-rest-slider-target="display"
                      style="min-width: 80px;">
                  <%= format_seconds(@user.default_rest_seconds) %>
                </span>
              </div>
              <div class="d-flex justify-content-between text-muted small mt-1">
                <span><%= format_seconds(User::MIN_REST_SECONDS) %></span>
                <span><%= format_seconds(User::MAX_REST_SECONDS) %></span>
              </div>
              <div class="form-text">Default rest time between sets</div>
            </div>

            <div class="mb-4">
              <%= form.label :progression_rep_target, "Progression Rep Target", class: "form-label" %>
              <%= form.number_field :progression_rep_target, 
                    class: "form-control #{'is-invalid' if @user.errors[:progression_rep_target].any?}",
                    min: User::MIN_PROGRESSION_REP_TARGET,
                    max: User::MAX_PROGRESSION_REP_TARGET,
                    step: 1 %>
              <% if @user.errors[:progression_rep_target].any? %>
                <div class="invalid-feedback"><%= @user.errors[:progression_rep_target].first %></div>
              <% end %>
              <div class="form-text">Target reps to hit consistently before progressing weight (typically 8-12 for hypertrophy)</div>
            </div>

            <div class="mb-4"
                 data-controller="notification-permission"
                 data-notification-permission-public-key-value="<%= WebPushConfig.public_key %>"
                 data-notification-permission-subscribe-url-value="<%= push_subscriptions_path %>"
                 data-notification-permission-unsubscribe-url-value="<%= push_subscriptions_path %>">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>Push Notifications</strong>
                  <span data-notification-permission-target="status" class="badge badge-sm bg-secondary ms-2">Checking...</span>
                  <div class="form-text mt-1">Rest timer alerts when app is in the background</div>
                </div>
                <button type="button" 
                        class="btn btn-sm btn-primary ms-3 flex-shrink-0"
                        data-notification-permission-target="button"
                        data-action="click->notification-permission#requestPermission">
                  Enable
                </button>
              </div>
            </div>

            <div class="mb-4">
              <div class="form-check form-switch">
                <%= form.check_box :weekly_summary_email, 
                    class: "form-check-input", 
                    id: "user_weekly_summary_email" %>
                <%= form.label :weekly_summary_email, class: "form-check-label" do %>
                  <strong>Weekly Email Summary</strong>
                  <div class="form-text mt-1">
                    Weekly performance summary every Sunday
                  </div>
                <% end %>
              </div>
            </div>

            <div class="text-end">
              <%= form.submit "Save Preferences", class: "btn btn-primary btn-sm" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Security -->
      <div class="section-header mb-2">
        <i class="bi bi-shield-lock me-1"></i> Security
      </div>
      <div class="card mb-4">
        <div class="card-body">
          <details<%= ' open' if @user.errors[:current_password].any? || @user.errors[:password].any? || @user.errors[:password_confirmation].any? %>>
            <summary class="d-flex justify-content-between align-items-center" style="cursor: pointer; list-style: none;">
              <div>
                <strong>Change Password</strong>
                <div class="form-text mt-1">Update your account password</div>
              </div>
              <i class="bi bi-chevron-down text-muted"></i>
            </summary>

            <div class="mt-3 pt-3 border-top">
              <%= form_with url: update_password_settings_path, method: :patch do |form| %>
                <% if @user.errors[:current_password].any? || @user.errors[:password].any? || @user.errors[:password_confirmation].any? %>
                  <div class="alert alert-danger">
                    <ul class="mb-0">
                      <% @user.errors[:current_password].each do |msg| %>
                        <li>Current password <%= msg %></li>
                      <% end %>
                      <% @user.errors[:password].each do |msg| %>
                        <li>Password <%= msg %></li>
                      <% end %>
                      <% @user.errors[:password_confirmation].each do |msg| %>
                        <li>Password confirmation <%= msg %></li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>

                <div class="mb-3">
                  <%= form.label :current_password, class: "form-label" %>
                  <%= form.password_field :current_password, class: "form-control #{'is-invalid' if @user.errors[:current_password].any?}", autocomplete: "current-password" %>
                  <% if @user.errors[:current_password].any? %>
                    <div class="invalid-feedback"><%= @user.errors[:current_password].first %></div>
                  <% end %>
                </div>

                <div class="mb-3">
                  <%= form.label :password, "New Password", class: "form-label" %>
                  <%= form.password_field :password, class: "form-control #{'is-invalid' if @user.errors[:password].any?}", autocomplete: "new-password" %>
                  <% if @user.errors[:password].any? %>
                    <div class="invalid-feedback"><%= @user.errors[:password].first %></div>
                  <% end %>
                </div>

                <div class="mb-3">
                  <%= form.label :password_confirmation, "Confirm New Password", class: "form-label" %>
                  <%= form.password_field :password_confirmation, class: "form-control #{'is-invalid' if @user.errors[:password_confirmation].any?}", autocomplete: "new-password" %>
                  <% if @user.errors[:password_confirmation].any? %>
                    <div class="invalid-feedback"><%= @user.errors[:password_confirmation].first %></div>
                  <% end %>
                </div>

                <div class="text-end">
                  <%= form.submit "Change Password", class: "btn btn-warning btn-sm" %>
                </div>
              <% end %>
            </div>
          </details>
        </div>
      </div>

      <!-- Data -->
      <div class="section-header mb-2">
        <i class="bi bi-download me-1"></i> Data Export
      </div>
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex gap-2 flex-wrap">
            <%= link_to export_data_settings_path, class: "btn btn-outline-primary btn-sm" do %>
              <i class="bi bi-filetype-json me-1"></i> All Data (JSON)
            <% end %>
            <%= link_to export_csv_settings_path, class: "btn btn-outline-primary btn-sm" do %>
              <i class="bi bi-filetype-csv me-1"></i> Workouts CSV
            <% end %>
            <%= link_to export_prs_settings_path, class: "btn btn-outline-primary btn-sm" do %>
              <i class="bi bi-trophy me-1"></i> PRs CSV
            <% end %>
          </div>
        </div>
      </div>

      <!-- Sign Out -->
      <div class="card mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <strong>Sign Out</strong>
            <div class="form-text">Sign out on this device</div>
          </div>
          <%= button_to session_path, method: :delete, class: "btn btn-outline-secondary btn-sm" do %>
            <i class="bi bi-box-arrow-right me-1"></i> Sign Out
          <% end %>
        </div>
      </div>

    </div>
  </div>
</div>
