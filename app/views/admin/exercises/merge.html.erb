<% content_for(:title, "Merge #{@exercise.name} - Haearn Admin") %>

<div class="mb-3">
  <%= link_to admin_exercise_path(@exercise), class: "text-muted text-decoration-none" do %>
    <i class="bi bi-arrow-left me-1"></i>Back to <%= @exercise.name %>
  <% end %>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-arrows-collapse me-2"></i>Merge Duplicate Exercise
      </div>
      <div class="card-body">
        <div class="alert alert-warning mb-4">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>This action is permanent.</strong>
          All workout history and template references for
          <strong><%= @exercise.name %></strong>
          will be reassigned to the target exercise, and then
          <strong><%= @exercise.name %></strong> will be deleted.
        </div>

        <!-- Exercise being merged (the duplicate) -->
        <div class="card mb-4" style="border-color: var(--bs-danger);">
          <div class="card-header bg-danger bg-opacity-25">
            <i class="bi bi-trash me-2"></i>Exercise to Remove (Duplicate)
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-sm-4">
                <div class="stat-label">Name</div>
                <div class="fw-semibold"><%= @exercise.name %></div>
              </div>
              <div class="col-sm-3">
                <div class="stat-label">Type</div>
                <div><span class="badge bg-secondary"><%= @exercise.exercise_type %></span></div>
              </div>
              <div class="col-sm-3">
                <div class="stat-label">Muscle Group</div>
                <div>
                  <% if @exercise.primary_muscle_group.present? %>
                    <span class="badge" style="background: <%= Exercise::MUSCLE_GROUP_COLORS[@exercise.primary_muscle_group] %>">
                      <%= Exercise::MUSCLE_GROUP_LABELS[@exercise.primary_muscle_group] %>
                    </span>
                  <% else %>
                    <span class="text-muted">Not set</span>
                  <% end %>
                </div>
              </div>
              <div class="col-sm-2">
                <div class="stat-label">Scope</div>
                <div>
                  <% if @exercise.global? %>
                    <span class="badge bg-rust">Global</span>
                  <% else %>
                    <span class="badge bg-secondary">User</span>
                  <% end %>
                </div>
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-sm-6">
                <div class="stat-label">Workout Uses</div>
                <div class="fs-5"><%= @usage_count %></div>
              </div>
              <div class="col-sm-6">
                <div class="stat-label">Template Uses</div>
                <div class="fs-5"><%= @template_count %></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Target exercise picker -->
        <div class="card" style="border-color: var(--bs-success);">
          <div class="card-header bg-success bg-opacity-25">
            <i class="bi bi-check-circle me-2"></i>Merge Into (Target Exercise)
          </div>
          <div class="card-body">
            <!-- Search -->
            <div class="mb-3">
              <%= form_with url: merge_admin_exercise_path(@exercise), method: :get, local: true, class: "d-flex gap-2" do |f| %>
                <div class="flex-grow-1">
                  <%= f.search_field :search, value: params[:search], class: "form-control", placeholder: "Search exercises...", autofocus: true %>
                </div>
                <button type="submit" class="btn btn-outline-secondary">
                  <i class="bi bi-search"></i>
                </button>
              <% end %>
            </div>

            <!-- Results table -->
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-hover align-middle mb-0">
                <thead class="sticky-top" style="background: var(--bs-card-bg);">
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Muscle Group</th>
                    <th>Scope</th>
                    <th class="text-end">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <% @target_exercises.limit(50).each do |exercise| %>
                    <tr>
                      <td class="fw-semibold"><%= exercise.name %></td>
                      <td><span class="badge bg-secondary"><%= exercise.exercise_type %></span></td>
                      <td>
                        <% if exercise.primary_muscle_group.present? %>
                          <span class="badge" style="background: <%= Exercise::MUSCLE_GROUP_COLORS[exercise.primary_muscle_group] %>">
                            <%= Exercise::MUSCLE_GROUP_LABELS[exercise.primary_muscle_group] %>
                          </span>
                        <% else %>
                          <span class="text-muted">â€”</span>
                        <% end %>
                      </td>
                      <td>
                        <% if exercise.global? %>
                          <span class="badge bg-rust">Global</span>
                        <% else %>
                          <span class="badge bg-secondary">User</span>
                        <% end %>
                      </td>
                      <td class="text-end">
                        <%= button_to merge_admin_exercise_path(@exercise),
                              method: :post,
                              params: { target_id: exercise.id },
                              class: "btn btn-sm btn-outline-success",
                              data: {
                                turbo_confirm: "Merge '#{@exercise.name}' into '#{exercise.name}'?\n\n" \
                                  "#{@usage_count} workout uses and #{@template_count} template uses will be reassigned.\n\n" \
                                  "'#{@exercise.name}' will be permanently deleted. This cannot be undone."
                              } do %>
                          <i class="bi bi-arrows-collapse me-1"></i>Merge into this
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                  <% if @target_exercises.limit(50).empty? %>
                    <tr>
                      <td colspan="5" class="text-center text-muted py-4">
                        <% if params[:search].present? %>
                          No exercises found matching "<%= params[:search] %>".
                        <% else %>
                          No other exercises available.
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help sidebar -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-question-circle me-2"></i>How Merge Works
      </div>
      <div class="card-body small text-muted">
        <ol class="ps-3 mb-0">
          <li class="mb-2">
            All <strong>workout history</strong> referencing
            "<%= @exercise.name %>" will be moved to the target exercise.
          </li>
          <li class="mb-2">
            All <strong>workout templates</strong> using this exercise
            will be updated to use the target.
          </li>
          <li class="mb-2">
            "<%= @exercise.name %>" will be <strong>permanently deleted</strong>.
          </li>
          <li class="mb-2">
            The target exercise's attributes (name, type, muscle group) are
            <strong>not changed</strong>.
          </li>
        </ol>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <i class="bi bi-lightbulb me-2"></i>Tips
      </div>
      <div class="card-body small text-muted">
        <ul class="ps-3 mb-0">
          <li class="mb-2">Merge user-created duplicates into the <strong>global</strong> version to consolidate data.</li>
          <li class="mb-2">Consider <strong>editing</strong> the target exercise first if its name or muscle group needs updating.</li>
          <li class="mb-2">All merges are logged in the <strong>audit log</strong>.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
