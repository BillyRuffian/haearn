<% show_plate_calc = workout_exercise.exercise.has_weight && workout_exercise.machine&.plate_loaded? %>
<% input_unit = input_weight_unit_for(workout_exercise) %>
<% initial_weight = set.weight_kg ? input_weight_value_for(set.weight_kg, workout_exercise) : last_weight_for(workout_exercise) %>
<% quick_log_mode = local_assigns.fetch(:quick_log_mode, false) %>

<% if workout_exercise.exercise.has_weight? %>
  <% suggester = ProgressionSuggester.new(workout_exercise: workout_exercise, user: Current.user) %>
  <% if (suggestion_msg = suggester.suggestion_message) %>
    <div class="d-flex align-items-center gap-2 mt-2 mb-2 small text-success">
      <i class="bi bi-arrow-up-circle-fill"></i>
      <span><%= suggestion_msg %></span>
    </div>
  <% end %>
<% end %>

<div <% if show_plate_calc %>data-controller="plate-calculator" 
     data-plate-calculator-weight-value="<%= initial_weight || 0 %>"
     data-plate-calculator-bar-weight-value="<%= input_unit == 'kg' ? 20 : 45 %>"
     data-plate-calculator-unit-value="<%= input_unit %>"
     data-plate-calculator-max-plates-per-side-value="6"
     data-plate-calculator-machine-type-value="<%= workout_exercise.machine&.equipment_type %>"<% end %>>
  <%= form_with model: set, 
      url: workout_workout_exercise_exercise_sets_path(workout, workout_exercise, quick_log: (quick_log_mode ? 1 : nil)),
      class: "add-set-form mt-2 #{'quick-log-form' if quick_log_mode}",
      data: { controller: "set-form", action: "submit->set-form#submitted" } do |form| %>
    
    <%# Row 1: Primary fields - Weight + Reps/Time/Distance %>
    <div class="row g-2 align-items-end">
      <% if workout_exercise.exercise.has_weight %>
        <div class="col">
          <label class="form-label small text-muted mb-1">Weight (<%= input_unit %>)</label>
          <%= form.number_field :weight_value,
              value: initial_weight,
              class: "form-control form-control-sm text-center",
              step: "any",
              inputmode: "decimal",
              onfocus: "this.select()",
              data: { 
                set_form_target: "weight",
                action: show_plate_calc ? "input->plate-calculator#updateWeight" : nil
              }.compact %>
        </div>
      <% end %>

      <div class="col">
        <% case workout_exercise.exercise.exercise_type %>
        <% when 'reps' %>
          <label class="form-label small text-muted mb-1">Reps</label>
          <%= form.number_field :reps,
              value: set.reps || last_reps_for(workout_exercise),
              class: "form-control form-control-sm text-center",
              inputmode: "numeric",
              onfocus: "this.select()",
              data: { set_form_target: "reps" } %>
        <% when 'time' %>
          <label class="form-label small text-muted mb-1">Seconds</label>
          <%= form.number_field :duration_seconds,
              value: set.duration_seconds || last_duration_for(workout_exercise),
              class: "form-control form-control-sm text-center",
              inputmode: "numeric",
              onfocus: "this.select()" %>
        <% when 'distance' %>
          <label class="form-label small text-muted mb-1">Meters</label>
          <%= form.number_field :distance_meters,
              value: set.distance_meters || last_distance_for(workout_exercise),
              class: "form-control form-control-sm text-center",
              inputmode: "decimal",
              step: "any",
              onfocus: "this.select()" %>
        <% end %>
      </div>
    </div>

    <%# Row 2: Secondary fields - Warmup, RPE, RIR, Submit %>
    <div class="row g-2 align-items-center mt-1">
      <% unless quick_log_mode %>
        <div class="col-auto">
          <label class="form-label small text-muted mb-1">Warmup</label>
          <div class="form-check d-flex justify-content-center">
            <%= form.check_box :is_warmup, class: "form-check-input", title: "Warmup set" %>
          </div>
        </div>

        <div class="col">
          <label class="form-label small text-muted mb-1" title="Rate of Perceived Exertion (1-10)">RPE</label>
          <%= form.number_field :rpe,
              value: set.rpe,
              class: "form-control form-control-sm text-center",
              placeholder: "—",
              min: 1,
              max: 10,
              step: 0.5,
              inputmode: "decimal",
              onfocus: "this.select()" %>
        </div>

        <div class="col">
          <label class="form-label small text-muted mb-1" title="Reps in Reserve (0-10)">RIR</label>
          <%= form.number_field :rir,
              value: set.rir,
              class: "form-control form-control-sm text-center",
              placeholder: "—",
              min: 0,
              max: 10,
              inputmode: "numeric",
              onfocus: "this.select()" %>
        </div>
      <% end %>

      <% if quick_log_mode %>
        <%= form.hidden_field :is_warmup, value: false %>
      <% end %>

      <div class="col-auto">
        <div class="mt-3">
          <%= form.submit(quick_log_mode ? "Log Set" : "✓",
              class: "btn btn-primary #{quick_log_mode ? '' : 'btn-sm'}",
              data: { set_form_target: "submit" }) %>
        </div>
      </div>
    </div>
  <% end %>

  <%# Plate calculator display for barbell/smith machine exercises %>
  <% if show_plate_calc %>
    <div class="plate-calculator mt-2">
      <div class="d-flex align-items-center gap-2 mb-1">
        <i class="bi bi-bar-chart-steps text-muted"></i>
        <span class="small text-muted">Plate Loading (per side)</span>
      </div>
      <div data-plate-calculator-target="display"></div>
    </div>
  <% end %>
</div>
