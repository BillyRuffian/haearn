<% show_plate_calc = workout_exercise.exercise.has_weight && workout_exercise.machine&.plate_loaded? %>
<% initial_weight = set.weight_kg ? Current.user.display_weight(set.weight_kg)&.round : last_weight_for(workout_exercise) %>

<div <% if show_plate_calc %>data-controller="plate-calculator" 
     data-plate-calculator-weight-value="<%= initial_weight || 0 %>"
     data-plate-calculator-bar-weight-value="<%= Current.user.preferred_unit == 'kg' ? 20 : 45 %>"
     data-plate-calculator-unit-value="<%= Current.user.preferred_unit %>"<% end %>>
  <%= form_with model: set, 
      url: workout_workout_exercise_exercise_sets_path(workout, workout_exercise),
      class: "add-set-form mt-2",
      data: { controller: "set-form", action: "submit->set-form#submitted" } do |form| %>
    
    <div class="row g-2 align-items-end">
      <% if workout_exercise.exercise.has_weight %>
        <div class="col">
          <label class="form-label small text-muted mb-1">Weight (<%= Current.user.preferred_unit %>)</label>
          <%= form.number_field :weight_value,
              value: initial_weight,
              class: "form-control form-control-sm text-center",
              step: "any",
              inputmode: "decimal",
              onfocus: "this.select()",
              data: { 
                set_form_target: "weight",
                action: show_plate_calc ? "input->plate-calculator#updateWeight" : nil
              }.compact %>
        </div>
      <% end %>

      <div class="col">
        <% case workout_exercise.exercise.exercise_type %>
        <% when 'reps' %>
          <label class="form-label small text-muted mb-1">Reps</label>
          <%= form.number_field :reps,
              value: set.reps || last_reps_for(workout_exercise),
              class: "form-control form-control-sm text-center",
              inputmode: "numeric",
              onfocus: "this.select()",
              data: { set_form_target: "reps" } %>
        <% when 'time' %>
          <label class="form-label small text-muted mb-1">Seconds</label>
          <%= form.number_field :duration_seconds,
              class: "form-control form-control-sm text-center",
              inputmode: "numeric",
              onfocus: "this.select()" %>
        <% when 'distance' %>
          <label class="form-label small text-muted mb-1">Meters</label>
          <%= form.number_field :distance_meters,
              class: "form-control form-control-sm text-center",
              inputmode: "decimal",
              step: "any",
              onfocus: "this.select()" %>
        <% end %>
      </div>

      <div class="col-auto">
        <div class="form-check pt-3">
          <%= form.check_box :is_warmup, class: "form-check-input" %>
          <%= form.label :is_warmup, "Warmup", class: "form-check-label small" %>
        </div>
      </div>

      <div class="col-auto">
        <%= form.submit "âœ“", class: "btn btn-primary btn-sm", data: { set_form_target: "submit" } %>
      </div>
    </div>
  <% end %>

  <%# Plate calculator display for barbell/smith machine exercises %>
  <% if show_plate_calc %>
    <div class="plate-calculator mt-2">
      <div class="d-flex align-items-center gap-2 mb-1">
        <i class="bi bi-bar-chart-steps text-muted"></i>
        <span class="small text-muted">Plate Loading (per side)</span>
      </div>
      <div data-plate-calculator-target="display"></div>
    </div>
  <% end %>
</div>
