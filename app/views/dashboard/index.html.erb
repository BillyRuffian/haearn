<div class="container py-4">
  <% if Current.user %>
    <!-- Logged in dashboard -->
    <div class="row mb-4">
      <div class="col">
        <p class="text-muted text-uppercase mb-1" style="letter-spacing: 0.1em; font-size: 0.85rem;">Welcome back</p>
        <h1 class="display-4 mb-0">
          <span class="text-rust"><%= Current.user.name %></span>
        </h1>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-5">
      <div class="col-md-6">
        <% active_workout = Current.user.active_workout %>
        <div class="card h-100 position-relative">
          <div class="card-body d-flex flex-column justify-content-center align-items-center py-5">
            <% if active_workout %>
              <i class="bi bi-lightning-charge display-1 text-forge mb-3"></i>
              <h3 class="mb-2">Workout In Progress</h3>
              <p class="text-muted text-center mb-2">
                <%= active_workout.gym&.name || "No gym selected" %> &middot;
                <%= active_workout.duration_minutes || 0 %> min
              </p>
              <p class="text-muted text-center small mb-4">
                <%= pluralize(active_workout.exercise_sets.count, "set") %> logged
              </p>
              <%= link_to "CONTINUE", workout_path(active_workout), class: "btn btn-primary btn-lg px-5" %>
            <% else %>
              <i class="bi bi-play-circle display-1 text-forge mb-3"></i>
              <h3 class="mb-2">Start Workout</h3>
              <p class="text-muted text-center mb-4">Begin a new training session</p>
              <%= link_to "LET'S GO", new_workout_path, class: "btn btn-primary btn-lg px-5" %>
            <% end %>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100 position-relative">
          <div class="card-body d-flex flex-column justify-content-center align-items-center py-5">
            <i class="bi bi-clock-history display-1 text-iron mb-3"></i>
            <h3 class="mb-2">View History</h3>
            <p class="text-muted text-center mb-4">Review past workouts</p>
            <%= link_to "BROWSE", workouts_path, class: "btn btn-secondary btn-lg px-5" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="row g-4">
      <div class="col-md-4">
        <div class="card text-center position-relative">
          <div class="card-body py-4">
            <h2 class="display-3 weight-display text-rust mb-0"><%= @workouts_this_week %></h2>
            <p class="text-muted text-uppercase mb-0" style="letter-spacing: 0.1em; font-size: 0.75rem;">Workouts This Week</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center position-relative">
          <div class="card-body py-4">
            <h2 class="display-3 weight-display mb-0"><%= number_to_si(@volume_this_week) %></h2>
            <p class="text-muted text-uppercase mb-0" style="letter-spacing: 0.1em; font-size: 0.75rem;">Volume This Week (<%= Current.user.preferred_unit %>)</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center position-relative">
          <div class="card-body py-4">
            <h2 class="display-3 weight-display text-forge mb-0"><%= @prs_this_month %></h2>
            <p class="text-muted text-uppercase mb-0" style="letter-spacing: 0.1em; font-size: 0.75rem;">PRs This Month</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Workout Frequency Chart -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-bar-chart me-2"></i>Workout Frequency
            </h5>
            <div data-controller="chart"
                 data-chart-type-value="bar"
                 data-chart-labels-value="<%= @workout_frequency.map { |w| w[:label] }.to_json %>"
                 data-chart-points-value="<%= @workout_frequency.map { |w| w[:count] }.to_json %>"
                 data-chart-label-value="Workouts"
                 data-chart-color-value="#ff6b35"
                 style="height: 200px;">
              <canvas data-chart-target="canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Calendar Heatmap -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative heatmap-card">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-3" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-calendar3 me-2"></i>Workout Consistency
            </h5>
            <div class="heatmap-container" 
                 data-controller="calendar-heatmap" 
                 data-calendar-heatmap-data-value="<%= @heatmap_data.to_json %>">
              <div data-calendar-heatmap-target="container"></div>
              <div class="heatmap-tooltip d-none" data-calendar-heatmap-target="tooltip"></div>
            </div>
          </div>
          <div class="heatmap-scroll-fade"></div>
        </div>
      </div>
    </div>

    <!-- PR Timeline -->
    <% if @pr_timeline_data.present? && @pr_timeline_data.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-trophy me-2"></i>PR Timeline
            </h5>
            <div data-controller="pr-timeline"
                 data-pr-timeline-data-value="<%= @pr_timeline_data.to_json %>"
                 style="height: <%= [200, 40 + (@pr_timeline_data.map { |pr| pr[:exercise] }.uniq.count * 30)].max %>px;">
              <canvas data-pr-timeline-target="canvas"></canvas>
            </div>
            <div class="text-center mt-3">
              <small class="text-muted">Bubble size represents relative weight</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent PRs Table -->
    <% recent_prs = @pr_timeline_data.last(10).reverse %>
    <% if recent_prs.any? %>
      <div class="row mt-4">
        <div class="col-12">
          <div class="card position-relative">
            <div class="card-body py-4">
              <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
                <i class="bi bi-list-ol me-2"></i>Recent Personal Records
              </h5>
              <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                  <thead>
                    <tr class="text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                      <th>Exercise</th>
                      <th class="text-end">Weight</th>
                      <th class="text-end">Reps</th>
                      <th class="text-center">Type</th>
                      <th class="text-end">Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% recent_prs.each do |pr| %>
                      <tr>
                        <td class="fw-bold"><%= pr[:exercise] %></td>
                        <td class="text-end">
                          <span class="weight-display text-forge"><%= pr[:weight] %></span>
                          <span class="text-muted small"><%= Current.user.preferred_unit %></span>
                        </td>
                        <td class="text-end"><%= pr[:reps] %></td>
                        <td class="text-center">
                          <% if pr[:type] == 'weight' %>
                            <span class="badge bg-forge" style="font-size: 0.7rem;">
                              <i class="bi bi-arrow-up"></i> MAX
                            </span>
                          <% else %>
                            <span class="badge bg-iron" style="font-size: 0.7rem;">
                              <i class="bi bi-graph-up"></i> VOL
                            </span>
                          <% end %>
                        </td>
                        <td class="text-end text-muted small">
                          <%= Date.parse(pr[:date]).strftime("%b %d") %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <% end %>

    <!-- Rep Range Distribution -->
    <% if @rep_range_data.values.sum > 0 %>
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-bar-chart-steps me-2"></i>Rep Range Distribution
              <small class="text-muted ms-2">(Last 30 days)</small>
            </h5>
            <div data-controller="rep-range-chart"
                 data-rep-range-chart-data-value="<%= @rep_range_data.to_json %>"
                 style="height: 160px;">
              <canvas data-rep-range-chart-target="canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card position-relative h-100">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-info-circle me-2"></i>Training Zones
            </h5>
            <div class="small">
              <div class="d-flex align-items-center mb-2">
                <span class="badge me-2" style="background: #a33a0c; width: 60px;">1-5</span>
                <span class="text-muted">Strength — Heavy loads, low reps</span>
              </div>
              <div class="d-flex align-items-center mb-2">
                <span class="badge me-2" style="background: #ff6b35; width: 60px;">6-10</span>
                <span class="text-muted">Hypertrophy — Optimal for muscle growth</span>
              </div>
              <div class="d-flex align-items-center mb-2">
                <span class="badge me-2" style="background: #f0a060; width: 60px;">11-15</span>
                <span class="text-muted">Endurance — Muscular endurance focus</span>
              </div>
              <div class="d-flex align-items-center">
                <span class="badge me-2" style="background: #71797E; width: 60px;">16+</span>
                <span class="text-muted">High rep — Conditioning, pump work</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Volume Distribution by Muscle Group -->
    <% if @muscle_group_data[:seven_days].any? || @muscle_group_data[:thirty_days].any? %>
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card position-relative h-100">
          <div class="card-body py-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="text-uppercase text-muted mb-0" style="letter-spacing: 0.1em; font-size: 0.85rem;">
                <i class="bi bi-pie-chart me-2"></i>Volume by Muscle
              </h5>
              <select class="form-select form-select-sm bg-dark text-light border-secondary" 
                      style="width: auto;"
                      data-muscle-group-chart-target="periodSelect"
                      data-action="change->muscle-group-chart#changePeriod">
                <option value="seven_days">7 Days</option>
                <option value="thirty_days">30 Days</option>
              </select>
            </div>
            <div data-controller="muscle-group-chart"
                 data-muscle-group-chart-seven-days-value="<%= @muscle_group_data[:seven_days].to_json %>"
                 data-muscle-group-chart-thirty-days-value="<%= @muscle_group_data[:thirty_days].to_json %>"
                 data-muscle-group-chart-colors-value="<%= @muscle_group_data[:colors].to_json %>"
                 data-muscle-group-chart-labels-value="<%= @muscle_group_data[:labels].to_json %>"
                 style="height: 200px;">
              <canvas data-muscle-group-chart-target="canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card position-relative h-100">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-list-ul me-2"></i>Muscle Group Breakdown
              <small class="text-muted ms-2">(Last 7 days)</small>
            </h5>
            <% total_volume = @muscle_group_data[:seven_days].values.sum %>
            <% if total_volume > 0 %>
              <div class="muscle-group-list" style="max-height: 200px; overflow-y: auto;">
                <% @muscle_group_data[:seven_days].each do |muscle_group, volume| %>
                  <% percentage = ((volume.to_f / total_volume) * 100).round(1) %>
                  <div class="d-flex align-items-center mb-2">
                    <span class="me-2" style="width: 12px; height: 12px; border-radius: 2px; background: <%= @muscle_group_data[:colors][muscle_group] %>;"></span>
                    <span class="flex-grow-1 text-truncate"><%= @muscle_group_data[:labels][muscle_group] %></span>
                    <span class="text-muted small me-2"><%= percentage %>%</span>
                    <span class="weight-display" style="min-width: 60px; text-align: right;">
                      <%= number_to_si(volume) %>
                    </span>
                  </div>
                <% end %>
              </div>
              <div class="border-top border-secondary pt-2 mt-2">
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Total</span>
                  <span class="weight-display">
                    <%= number_to_si(total_volume) %><span class="text-muted small ms-1"><%= Current.user.preferred_unit %></span>
                  </span>
                </div>
              </div>
            <% else %>
              <p class="text-muted text-center mb-0">No workout data in the last 7 days</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Muscle Training Spider Chart -->
    <% has_muscle_data = @muscle_group_data[:seven_days].values.any? { |v| v > 0 } || @muscle_group_data[:thirty_days].values.any? { |v| v > 0 } %>
    <% if has_muscle_data %>
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card position-relative h-100">
          <div class="card-body py-4"
               data-controller="muscle-spider-chart"
               data-muscle-spider-chart-seven-days-value="<%= @muscle_group_data[:seven_days].to_json %>"
               data-muscle-spider-chart-thirty-days-value="<%= @muscle_group_data[:thirty_days].to_json %>"
               data-muscle-spider-chart-labels-value="<%= Exercise::MUSCLE_GROUP_LABELS.to_json %>">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="text-uppercase text-muted mb-0" style="letter-spacing: 0.1em; font-size: 0.85rem;">
                <i class="bi bi-diagram-3 me-2"></i>Muscle Balance
              </h5>
              <select class="form-select form-select-sm w-auto" 
                      data-muscle-spider-chart-target="periodSelect"
                      data-action="change->muscle-spider-chart#periodChanged"
                      style="background-color: #2a2a2a; border-color: #3a3a3a; color: #e0e0e0;">
                <option value="seven_days">Last 7 days</option>
                <option value="thirty_days">Last 30 days</option>
              </select>
            </div>
            <div style="height: 280px;">
              <canvas data-muscle-spider-chart-target="canvas"></canvas>
            </div>
            <div class="text-center mt-2">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Volume distribution across muscle groups
              </small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card position-relative h-100">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-bar-chart-fill me-2"></i>Volume Breakdown
            </h5>
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-dark table-sm mb-0">
                <thead class="sticky-top" style="background-color: #1a1a1a;">
                  <tr class="text-muted" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                    <th>Muscle</th>
                    <th class="text-end">7 Days</th>
                    <th class="text-end">30 Days</th>
                  </tr>
                </thead>
                <tbody>
                  <% Exercise::MUSCLE_GROUPS.each do |muscle| %>
                    <% seven = @muscle_group_data[:seven_days][muscle] || 0 %>
                    <% thirty = @muscle_group_data[:thirty_days][muscle] || 0 %>
                    <% next if seven == 0 && thirty == 0 %>
                    <% color = Exercise::MUSCLE_GROUP_COLORS[muscle] %>
                    <tr>
                      <td>
                        <span class="d-inline-block rounded-circle me-2" 
                              style="width: 10px; height: 10px; background-color: <%= color %>;"></span>
                        <%= Exercise::MUSCLE_GROUP_LABELS[muscle] %>
                      </td>
                      <td class="text-end">
                        <% if seven > 0 %>
                          <span class="weight-display"><%= number_to_si(seven) %></span>
                          <span class="text-muted small"><%= Current.user.preferred_unit %></span>
                        <% else %>
                          <span class="text-muted">—</span>
                        <% end %>
                      </td>
                      <td class="text-end">
                        <% if thirty > 0 %>
                          <span class="weight-display"><%= number_to_si(thirty) %></span>
                          <span class="text-muted small"><%= Current.user.preferred_unit %></span>
                        <% else %>
                          <span class="text-muted">—</span>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Strength Curve -->
    <% if @strength_curve_data.present? && @strength_curve_data.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-graph-down me-2"></i>Strength Curve
              <small class="text-muted ms-2">(Max weight by rep range)</small>
            </h5>
            <div data-controller="strength-curve"
                 data-strength-curve-data-value="<%= @strength_curve_data.to_json %>"
                 style="height: 250px;">
              <canvas data-strength-curve-target="canvas"></canvas>
            </div>
            <div class="text-center mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Steep curve = strength-focused | Flat curve = better endurance capacity
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Session Duration Trends -->
    <% if @session_duration_data.length > 2 %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-clock-history me-2"></i>Session Duration Trends
              <small class="text-muted ms-2">(Last <%= @session_duration_data.length %> workouts)</small>
            </h5>
            <div data-controller="session-duration"
                 data-session-duration-data-value="<%= @session_duration_data.to_json %>"
                 style="height: 200px;">
              <canvas data-session-duration-target="canvas"></canvas>
            </div>
            <div class="text-center mt-2">
              <small class="text-muted">
                Average: <%= (@session_duration_data.sum { |d| d[:duration] } / @session_duration_data.length.to_f).round %> min
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Training Density -->
    <% if @training_density_data.length > 2 %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-speedometer2 me-2"></i>Training Density
              <small class="text-muted ms-2">(Volume per minute)</small>
            </h5>
            <div data-controller="chart"
                 data-chart-type-value="line"
                 data-chart-labels-value="<%= @training_density_data.map { |d| Date.parse(d[:date]).strftime('%b %d') }.to_json %>"
                 data-chart-points-value="<%= @training_density_data.map { |d| d[:density] }.to_json %>"
                 data-chart-label-value="<%= Current.user.preferred_unit %>/min"
                 data-chart-color-value="#71797E"
                 data-chart-fill-value="true"
                 style="height: 180px;">
              <canvas data-chart-target="canvas"></canvas>
            </div>
            <div class="text-center mt-2">
              <small class="text-muted">
                <% avg_density = (@training_density_data.sum { |d| d[:density] } / @training_density_data.length.to_f).round %>
                Average: <%= avg_density %> <%= Current.user.preferred_unit %>/min
                <span class="mx-2">•</span>
                Higher = more efficient workouts
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Consistency Streaks & Week Comparison -->
    <div class="row mt-4 g-4">
      <!-- Consistency Streaks -->
      <div class="col-md-6">
        <div class="card position-relative h-100">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-fire me-2"></i>Consistency Streaks
            </h5>
            <div class="row text-center">
              <div class="col-6">
                <div class="p-3 rounded" style="background: rgba(255, 107, 53, 0.1);">
                  <div class="display-4 weight-display text-forge mb-1">
                    <%= @streak_data[:current] %>
                  </div>
                  <p class="text-muted text-uppercase mb-0" style="font-size: 0.7rem; letter-spacing: 0.05em;">
                    Current Streak
                  </p>
                  <p class="text-muted small mb-0">(weeks)</p>
                </div>
              </div>
              <div class="col-6">
                <div class="p-3 rounded" style="background: rgba(113, 121, 126, 0.1);">
                  <div class="display-4 weight-display text-iron mb-1">
                    <%= @streak_data[:longest] %>
                  </div>
                  <p class="text-muted text-uppercase mb-0" style="font-size: 0.7rem; letter-spacing: 0.05em;">
                    Longest Streak
                  </p>
                  <p class="text-muted small mb-0">(weeks)</p>
                </div>
              </div>
            </div>
            <% if @streak_data[:last_workout_days_ago] %>
              <div class="text-center mt-3">
                <small class="text-muted">
                  <% if @streak_data[:last_workout_days_ago] == 0 %>
                    <i class="bi bi-lightning-charge text-forge"></i> You worked out today!
                  <% elsif @streak_data[:last_workout_days_ago] == 1 %>
                    <i class="bi bi-check-circle text-success"></i> Last workout: yesterday
                  <% elsif @streak_data[:last_workout_days_ago] <= 3 %>
                    <i class="bi bi-check-circle text-success"></i> Last workout: <%= @streak_data[:last_workout_days_ago] %> days ago
                  <% elsif @streak_data[:last_workout_days_ago] <= 7 %>
                    <i class="bi bi-exclamation-triangle text-warning"></i> Last workout: <%= @streak_data[:last_workout_days_ago] %> days ago
                  <% else %>
                    <i class="bi bi-exclamation-circle text-danger"></i> Last workout: <%= @streak_data[:last_workout_days_ago] %> days ago
                  <% end %>
                </small>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Week-over-Week Comparison -->
      <div class="col-md-6">
        <div class="card position-relative h-100">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-arrow-left-right me-2"></i>Week Comparison
            </h5>
            <div class="table-responsive">
              <table class="table table-dark table-sm mb-0">
                <thead>
                  <tr class="text-muted" style="font-size: 0.75rem;">
                    <th></th>
                    <th class="text-end">This Week</th>
                    <th class="text-end">Last Week</th>
                    <th class="text-end">Change</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="text-muted">Volume</td>
                    <td class="text-end">
                      <span class="weight-display"><%= number_to_si(@week_comparison_data[:this_week][:volume]) %></span>
                      <span class="text-muted small"><%= Current.user.preferred_unit %></span>
                    </td>
                    <td class="text-end text-muted">
                      <%= number_to_si(@week_comparison_data[:last_week][:volume]) %>
                    </td>
                    <td class="text-end">
                      <% vol_diff = @week_comparison_data[:this_week][:volume] - @week_comparison_data[:last_week][:volume] %>
                      <% if @week_comparison_data[:last_week][:volume] > 0 %>
                        <% vol_pct = ((vol_diff.to_f / @week_comparison_data[:last_week][:volume]) * 100).round %>
                        <% if vol_diff > 0 %>
                          <span class="text-success"><i class="bi bi-arrow-up-short"></i><%= vol_pct %>%</span>
                        <% elsif vol_diff < 0 %>
                          <span class="text-danger"><i class="bi bi-arrow-down-short"></i><%= vol_pct.abs %>%</span>
                        <% else %>
                          <span class="text-muted">—</span>
                        <% end %>
                      <% else %>
                        <span class="text-muted">—</span>
                      <% end %>
                    </td>
                  </tr>
                  <tr>
                    <td class="text-muted">Workouts</td>
                    <td class="text-end weight-display"><%= @week_comparison_data[:this_week][:workouts] %></td>
                    <td class="text-end text-muted"><%= @week_comparison_data[:last_week][:workouts] %></td>
                    <td class="text-end">
                      <% wo_diff = @week_comparison_data[:this_week][:workouts] - @week_comparison_data[:last_week][:workouts] %>
                      <% if wo_diff > 0 %>
                        <span class="text-success"><i class="bi bi-arrow-up-short"></i><%= wo_diff %></span>
                      <% elsif wo_diff < 0 %>
                        <span class="text-danger"><i class="bi bi-arrow-down-short"></i><%= wo_diff.abs %></span>
                      <% else %>
                        <span class="text-muted">—</span>
                      <% end %>
                    </td>
                  </tr>
                  <tr>
                    <td class="text-muted">Sets</td>
                    <td class="text-end weight-display"><%= @week_comparison_data[:this_week][:sets] %></td>
                    <td class="text-end text-muted"><%= @week_comparison_data[:last_week][:sets] %></td>
                    <td class="text-end">
                      <% set_diff = @week_comparison_data[:this_week][:sets] - @week_comparison_data[:last_week][:sets] %>
                      <% if set_diff > 0 %>
                        <span class="text-success"><i class="bi bi-arrow-up-short"></i><%= set_diff %></span>
                      <% elsif set_diff < 0 %>
                        <span class="text-danger"><i class="bi bi-arrow-down-short"></i><%= set_diff.abs %></span>
                      <% else %>
                        <span class="text-muted">—</span>
                      <% end %>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Body Map Heatmap (Muscle Recovery) -->
    <% if @body_map_data.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-person-arms-up me-2"></i>Muscle Recovery Status
            </h5>
            <div class="position-relative"
                 data-controller="body-map"
                 data-body-map-data-value="<%= @body_map_data.to_json %>">
              <div data-body-map-target="container"></div>
              <div class="body-map-tooltip d-none" data-body-map-target="tooltip"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Exercise Frequency Ranking -->
    <% if @exercise_frequency_data.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-bar-chart-line me-2"></i>Most Performed Exercises
              <small class="text-muted ms-2">(Last 90 days)</small>
            </h5>
            <div data-controller="chart"
                 data-chart-type-value="bar"
                 data-chart-labels-value="<%= @exercise_frequency_data.map { |d| d[:exercise] }.to_json %>"
                 data-chart-points-value="<%= @exercise_frequency_data.map { |d| d[:count] }.to_json %>"
                 data-chart-label-value="Sessions"
                 data-chart-color-value="#ff6b35"
                 data-chart-horizontal-value="true"
                 style="height: <%= [180, @exercise_frequency_data.length * 32].max %>px;">
              <canvas data-chart-target="canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Tonnage Tracker -->
    <% if @tonnage_data.any? && @tonnage_data.sum { |d| d[:volume] } > 0 %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-graph-up-arrow me-2"></i>Tonnage Tracker
              <small class="text-muted ms-2">(Weekly volume - last 12 weeks)</small>
            </h5>
            <div data-controller="chart"
                 data-chart-type-value="line"
                 data-chart-labels-value="<%= @tonnage_data.map { |d| d[:label] }.to_json %>"
                 data-chart-points-value="<%= @tonnage_data.map { |d| d[:volume] }.to_json %>"
                 data-chart-label-value="Volume (<%= Current.user.preferred_unit %>)"
                 data-chart-color-value="#ff6b35"
                 data-chart-fill-value="true"
                 style="height: 200px;">
              <canvas data-chart-target="canvas"></canvas>
            </div>
            <div class="text-center mt-2">
              <small class="text-muted">
                <% total_tonnage = @tonnage_data.sum { |d| d[:volume] } %>
                <% avg_tonnage = (total_tonnage / @tonnage_data.length.to_f).round %>
                Total: <%= number_to_si(total_tonnage) %><%= Current.user.preferred_unit %> &middot;
                Average: <%= number_to_si(avg_tonnage) %><%= Current.user.preferred_unit %>/week
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Plateau Detector -->
    <% if @plateau_data.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative border-warning" style="border-color: rgba(255, 193, 7, 0.3) !important;">
          <div class="card-body py-4">
            <h5 class="text-uppercase text-muted mb-4" style="letter-spacing: 0.1em; font-size: 0.85rem;">
              <i class="bi bi-exclamation-triangle text-warning me-2"></i>Plateau Alert
              <small class="text-muted ms-2">(No PR in 4+ weeks)</small>
            </h5>
            <div class="table-responsive">
              <table class="table table-dark table-sm mb-0">
                <thead>
                  <tr class="text-muted" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                    <th>Exercise</th>
                    <th class="text-center">Weeks Stuck</th>
                    <th class="text-end">Best Weight</th>
                    <th class="text-end">Last PR</th>
                  </tr>
                </thead>
                <tbody>
                  <% @plateau_data.each do |plateau| %>
                    <tr>
                      <td class="fw-bold"><%= plateau[:exercise] %></td>
                      <td class="text-center">
                        <span class="badge <%= plateau[:weeks_since_pr] >= 8 ? 'bg-danger' : 'bg-warning text-dark' %>">
                          <%= plateau[:weeks_since_pr] %> weeks
                        </span>
                      </td>
                      <td class="text-end">
                        <span class="weight-display"><%= plateau[:best_weight] %></span>
                        <span class="text-muted small"><%= Current.user.preferred_unit %></span>
                      </td>
                      <td class="text-end text-muted small"><%= plateau[:last_pr_date] %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-lightbulb me-1"></i>
                Try varying rep ranges, adding volume, or taking a deload week to break through plateaus.
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Recent Workouts -->
    <% if @recent_workouts.any? %>
      <div class="row mt-5">
        <div class="col-12">
          <div class="card position-relative">
            <div class="card-body py-4">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="text-uppercase text-muted mb-0" style="letter-spacing: 0.1em; font-size: 0.85rem;">
                  <i class="bi bi-clock-history me-2"></i>Recent Workouts
                </h5>
                <%= link_to "View All", workouts_path, class: "btn btn-sm btn-outline-secondary" %>
              </div>
              <div class="list-group list-group-flush">
                <% @recent_workouts.each do |workout| %>
                  <%= link_to workout_path(workout), class: "list-group-item list-group-item-action bg-transparent border-secondary px-0 py-3" do %>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-1"><%= workout.gym&.name || "Workout" %></h6>
                        <small class="text-muted">
                          <%= workout.finished_at.strftime("%b %d, %Y") %> &middot;
                          <%= workout.duration_minutes || 0 %> min &middot;
                          <%= pluralize(workout.workout_exercises.count, "exercise") %>
                        </small>
                      </div>
                      <div class="text-end">
                        <span class="text-muted">
                          <%= number_with_delimiter(Current.user.display_weight(workout.total_volume_kg).round) %><%= Current.user.preferred_unit %>
                        </span>
                        <i class="bi bi-chevron-right ms-2 text-muted"></i>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <!-- Landing page for logged out users -->
    <div class="row min-vh-75 align-items-center py-5">
      <div class="col-lg-7 mb-5 mb-lg-0">
        <p class="text-muted text-uppercase mb-2" style="letter-spacing: 0.2em; font-size: 0.85rem;">Hardcore Weightlifting Tracker</p>
        <h1 class="display-2 fw-bold mb-4" style="line-height: 0.95;">
          <span class="d-block">Forge Your</span>
          <span class="text-rust">Strength</span>
        </h1>
        <p class="lead text-muted mb-4" style="font-size: 1.1rem; max-width: 500px;">
          Built for serious lifters. Track machines, cable ratios, supersets, and every detail that matters.
        </p>
        <ul class="list-unstyled mb-5">
          <li class="mb-2"><i class="bi bi-check2-circle text-rust me-2"></i> Track specific machines & equipment</li>
          <li class="mb-2"><i class="bi bi-check2-circle text-rust me-2"></i> Cable pulley ratio calculations</li>
          <li class="mb-2"><i class="bi bi-check2-circle text-rust me-2"></i> Superset & circuit support</li>
          <li class="mb-2"><i class="bi bi-check2-circle text-rust me-2"></i> Personal records & progress charts</li>
        </ul>
        <div class="d-flex gap-3 flex-wrap">
          <%= link_to "GET STARTED", new_registration_path, class: "btn btn-primary btn-lg px-4" %>
          <%= link_to "SIGN IN", new_session_path, class: "btn btn-outline-primary btn-lg px-4" %>
        </div>
      </div>
      <div class="col-lg-5 text-center">
        <div class="position-relative">
          <i class="bi bi-fire" style="font-size: 12rem; background: linear-gradient(180deg, #ff6b35 0%, #c94d14 50%, #7a2d09 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; filter: drop-shadow(0 0 40px rgba(201, 77, 20, 0.4));"></i>
        </div>
        <p class="text-muted fst-italic mt-3" style="letter-spacing: 0.15em;">"Iron" in Welsh</p>
      </div>
    </div>
  <% end %>
</div>
