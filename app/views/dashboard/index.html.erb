<div class="container py-4">
  <% if Current.user %>
    <!-- Logged in dashboard -->
    <div class="row mb-4">
      <div class="col">
        <p class="section-header mb-1">Welcome back</p>
        <h1 class="display-heading mb-0">
          <span class="text-rust"><%= Current.user.name %></span>
        </h1>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-5">
      <div class="col-md-6">
        <% active_workout = Current.user.active_workout %>
        <div class="card h-100 position-relative">
          <div class="card-body d-flex flex-column justify-content-center align-items-center py-5">
            <% if active_workout %>
              <i class="bi bi-lightning-charge display-1 text-forge mb-3"></i>
              <h3 class="mb-2">Workout In Progress</h3>
              <p class="text-muted text-center mb-2">
                <%= active_workout.gym&.name || "No gym selected" %> &middot;
                <%= active_workout.duration_minutes || 0 %> min
              </p>
              <p class="text-muted text-center small mb-4">
                <%= pluralize(active_workout.exercise_sets.count, "set") %> logged
              </p>
              <%= link_to "CONTINUE", workout_path(active_workout), class: "btn btn-primary btn-lg px-5" %>
            <% else %>
              <i class="bi bi-play-circle display-1 text-forge mb-3"></i>
              <h3 class="mb-2">Start Workout</h3>
              <p class="text-muted text-center mb-4">Begin a new training session</p>
              <%= link_to "LET'S GO", new_workout_path, class: "btn btn-primary btn-lg px-5" %>
            <% end %>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100 position-relative">
          <div class="card-body d-flex flex-column justify-content-center align-items-center py-5">
            <i class="bi bi-clock-history display-1 text-iron mb-3"></i>
            <h3 class="mb-2">View History</h3>
            <p class="text-muted text-center mb-4">Review past workouts</p>
            <%= link_to "BROWSE", workouts_path, class: "btn btn-secondary btn-lg px-5" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Pinned Templates -->
    <% if @pinned_templates.any? %>
    <div class="row mb-4">
      <div class="col-12">
        <h5 class="section-header mb-3">
          <i class="bi bi-pin-angle-fill me-2 text-warning"></i>Pinned Routines
        </h5>
        <div class="row g-3">
          <% @pinned_templates.each do |template| %>
            <div class="col-6 col-md-4 col-lg-3">
              <div class="card h-100">
                <div class="card-body py-3 text-center">
                  <h6 class="card-title mb-1"><%= template.name %></h6>
                  <small class="text-muted">
                    <%= pluralize(template.template_exercises.count, 'exercise') %>
                  </small>
                  <div class="mt-2">
                    <%= button_to start_workout_workout_template_path(template),
                        class: "btn btn-sm btn-primary w-100",
                        data: { turbo_frame: "_top" } do %>
                      <i class="bi bi-play-fill me-1"></i>Start
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Training Intelligence Alerts -->
    <% if @readiness_alerts.any? || @fatigue_data.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <!-- Progression Readiness Alerts -->
        <% @readiness_alerts.each do |alert| %>
          <div class="alert alert-success alert-dismissible fade show mb-3">
            <div class="d-flex align-items-start">
              <i class="bi bi-trophy-fill me-3 mt-1" style="font-size: 1.5rem;"></i>
              <div class="flex-fill">
                <h6 class="mb-1 fw-bold">Ready to Progress!</h6>
                <p class="mb-2"><%= alert[:message] %></p>
                <div class="d-flex gap-3 small text-white-50">
                  <span><i class="bi bi-check-circle me-1"></i> <%= pluralize(alert[:readiness][:sessions_analyzed], 'session') %> analyzed</span>
                  <span><i class="bi bi-arrow-repeat me-1"></i> Avg <%= alert[:readiness][:avg_reps].round(1) %> reps</span>
                  <span><i class="bi bi-bullseye me-1"></i> <%= alert[:readiness][:consistency_rate] * 100 %>% consistency</span>
                </div>
                <div class="mt-2">
                  <%= link_to "View History", history_exercise_path(alert[:exercise], machine_id: alert[:machine]&.id), class: "btn btn-sm btn-success" %>
                </div>
              </div>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
          </div>
        <% end %>

        <!-- Fatigue Indicators (Active Workout Only) -->
        <% @fatigue_data.each do |data| %>
          <% analysis = data[:analysis] %>
          <% we = data[:workout_exercise] %>
          <div class="alert alert-<%= data[:color] %> alert-dismissible fade show mb-3">
            <div class="d-flex align-items-start">
              <i class="bi bi-activity me-3 mt-1" style="font-size: 1.5rem;"></i>
              <div class="flex-fill">
                <h6 class="mb-1 fw-bold">
                  <%= we.exercise.name %><% if we.machine %> (<%= we.machine.name %>)<% end %>
                </h6>
                <p class="mb-2"><%= data[:message] %></p>
                <div class="d-flex gap-3 small text-white-50">
                  <span><i class="bi bi-clipboard-data me-1"></i> <%= pluralize(analysis[:sessions_analyzed], 'session') %> baseline</span>
                  <span>
                    <i class="bi bi-arrow-down-up me-1"></i>
                    Current: <%= WeightConverter.from_kg(analysis[:current_performance][:volume_kg], Current.user.preferred_unit) %> vol
                  </span>
                  <span>
                    <i class="bi bi-clock-history me-1"></i>
                    Baseline: <%= WeightConverter.from_kg(analysis[:baseline_performance][:volume_kg], Current.user.preferred_unit) %> vol
                  </span>
                  <% if analysis[:current_performance][:avg_rpe] %>
                    <span><i class="bi bi-speedometer2 me-1"></i> RPE <%= analysis[:current_performance][:avg_rpe].round(1) %></span>
                  <% end %>
                </div>
              </div>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>

    <!-- Dynamic Performance Notifications -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative"
             data-controller="notifications-center"
             data-notifications-center-feed-url-value="<%= feed_notifications_path %>"
             data-notifications-center-mark-all-url-value="<%= mark_all_read_notifications_path %>"
             data-notifications-center-poll-interval-value="30000"
             data-notifications-center-unread-only-value="true">
          <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="section-header mb-0">
                <i class="bi bi-bell-fill me-2"></i>Live Performance Alerts
              </h5>
              <button class="btn btn-sm btn-link text-muted p-0" data-action="notifications-center#markAllRead">
                Mark all read
              </button>
            </div>
            <div data-notifications-center-target="loading" class="small text-muted d-none">Refreshing alertsâ€¦</div>
            <div data-notifications-center-target="empty" class="small text-muted">No active alerts. Keep training.</div>
            <div data-notifications-center-target="list" class="list-group list-group-flush mt-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="row g-4">
      <div class="col-md-3">
        <div class="card text-center position-relative">
          <div class="card-body py-4">
            <h2 class="display-3 weight-display text-rust mb-0"><%= @workouts_this_week %></h2>
            <p class="stat-label">Workouts This Week</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center position-relative">
          <div class="card-body py-4">
            <h2 class="display-3 weight-display mb-0"><%= number_to_si(@volume_this_week) %></h2>
            <p class="stat-label">Volume This Week (<%= Current.user.preferred_unit %>)</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center position-relative">
          <div class="card-body py-4">
            <h2 class="display-3 weight-display text-forge mb-0"><%= @prs_this_month %></h2>
            <p class="stat-label">PRs This Month</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <%= link_to body_metrics_path, class: "text-decoration-none" do %>
          <div class="card text-center position-relative h-100">
            <div class="card-body py-4">
              <% if @current_weight_kg %>
                <h2 class="display-3 weight-display mb-0">
                  <%= WeightConverter.from_kg(@current_weight_kg, Current.user.preferred_unit).round(1) %>
                </h2>
                <p class="stat-label">
                  Bodyweight (<%= Current.user.preferred_unit %>)
                </p>
              <% else %>
                <i class="bi bi-person-plus display-4 text-muted mb-2"></i>
                <p class="text-muted mb-0">Log Weight</p>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>


    <!-- Analytics Shortcut -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card position-relative">
          <div class="card-body py-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
              <h5 class="section-header mb-1">
                <i class="bi bi-graph-up-arrow me-2"></i>Analytics
              </h5>
              <p class="text-muted mb-0 small">All charts and deep performance insights now live in the Analytics tab.</p>
            </div>
            <%= link_to analytics_path, class: "btn btn-outline-primary" do %>
              <i class="bi bi-bar-chart-line me-1"></i>Open Analytics
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Workouts -->
    <% if @recent_workouts.any? %>
      <div class="row mt-5">
        <div class="col-12">
          <div class="card position-relative">
            <div class="card-body py-4">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="section-header mb-0">
                  <i class="bi bi-clock-history me-2"></i>Recent Workouts
                </h5>
                <%= link_to "View All", workouts_path, class: "btn btn-sm btn-outline-secondary" %>
              </div>
              <div class="list-group list-group-flush">
                <% @recent_workouts.each do |workout| %>
                  <%= link_to workout_path(workout), class: "list-group-item list-group-item-action bg-transparent border-secondary px-0 py-3" do %>
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <h6 class="mb-1"><%= workout.gym&.name || "Workout" %></h6>
                        <small class="text-muted">
                          <%= workout.finished_at.strftime("%b %d, %Y") %> &middot;
                          <%= workout.duration_minutes || 0 %> min &middot;
                          <%= pluralize(workout.workout_exercises.count, "exercise") %>
                        </small>
                        <div class="mt-2">
                          <%= render "workouts/muscle_group_badges", workout: workout %>
                        </div>
                      </div>
                      <div class="text-end ms-3">
                        <span class="text-muted">
                          <%= number_with_delimiter(Current.user.display_weight(workout.total_volume_kg).round) %><%= Current.user.preferred_unit %>
                        </span>
                        <i class="bi bi-chevron-right ms-2 text-muted"></i>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <!-- Landing page for logged out users -->
    <div class="row min-vh-75 align-items-center py-5">
      <div class="col-lg-7 mb-5 mb-lg-0">
        <p class="section-header mb-2">Hardcore Weightlifting Tracker</p>
        <h1 class="display-2 fw-bold mb-4" style="line-height: 0.95;">
          <span class="d-block">Forge Your</span>
          <span class="text-rust">Strength</span>
        </h1>
        <p class="lead text-muted mb-4" style="font-size: 1.1rem; max-width: 500px;">
          Built for serious lifters. Track machines, cable ratios, supersets, and every detail that matters.
        </p>
        <ul class="list-unstyled mb-5">
          <li class="mb-2"><i class="bi bi-check2-circle text-rust me-2"></i> Track specific machines & equipment</li>
          <li class="mb-2"><i class="bi bi-check2-circle text-rust me-2"></i> Cable pulley ratio calculations</li>
          <li class="mb-2"><i class="bi bi-check2-circle text-rust me-2"></i> Superset & circuit support</li>
          <li class="mb-2"><i class="bi bi-check2-circle text-rust me-2"></i> Personal records & progress charts</li>
        </ul>
        <div class="d-flex gap-3 flex-wrap">
          <%= link_to "GET STARTED", new_registration_path, class: "btn btn-primary btn-lg px-4" %>
          <%= link_to "SIGN IN", new_session_path, class: "btn btn-outline-primary btn-lg px-4" %>
        </div>
      </div>
      <div class="col-lg-5 text-center">
        <div class="position-relative">
          <i class="bi bi-fire" style="font-size: 12rem; background: linear-gradient(180deg, #ff6b35 0%, #c94d14 50%, #7a2d09 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; filter: drop-shadow(0 0 40px rgba(201, 77, 20, 0.4));"></i>
        </div>
        <p class="text-muted fst-italic mt-3" style="letter-spacing: 0.15em;">"Iron" in Welsh</p>
      </div>
    </div>
  <% end %>
</div>
