<%= turbo_frame_tag "modal" do %>
  <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.8);"
       data-controller="modal"
       data-modal-close-url-value="<%= workout_path(@workout) %>"
       data-action="click->modal#backdropClick">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <% if @target_block %>
              <i class="bi bi-arrow-repeat me-2 text-warning"></i>Add to Superset
            <% else %>
              <i class="bi bi-plus-circle me-2"></i>Add Exercise
            <% end %>
          </h5>
          <%= link_to workout_path(@workout), class: "btn-close", data: { turbo_frame: "modal" } %>
        </div>
        
        <% if @target_block %>
          <div class="alert alert-warning m-3 mb-0 py-2">
            <i class="bi bi-info-circle me-1"></i>
            Adding to Block <%= @target_block.position %> 
            <% if @target_block.workout_exercises.any? %>
              (with <%= @target_block.workout_exercises.map { |we| we.exercise.name }.to_sentence %>)
            <% end %>
          </div>
        <% end %>
        
        <div class="modal-body p-0">
          <% if @selected_exercise %>
            <!-- Step 2: Equipment Selection -->
            <div class="p-3 border-bottom">
              <h6 class="mb-0"><%= @selected_exercise.name %></h6>
              <small class="text-muted">Select equipment (optional)</small>
            </div>
            
            <% if @machines.any? %>
              <div data-controller="equipment-filter">
                <!-- Search Equipment -->
                <div class="p-3 border-bottom sticky-top bg-body">
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search equipment..." 
                           data-equipment-filter-target="input"
                           data-action="input->equipment-filter#filter">
                  </div>
                </div>
                
                <div class="list-group list-group-flush" data-equipment-filter-target="list">
                  <!-- Create new equipment option -->
                  <%= link_to new_gym_machine_path(@workout.gym, return_to: add_exercise_workout_path(@workout, select_exercise: @selected_exercise.id, to_block: @target_block&.id)),
                      class: "list-group-item list-group-item-action text-primary",
                      data: { turbo_frame: "_top" } do %>
                    <i class="bi bi-plus-lg me-2"></i>Add new equipment...
                  <% end %>

                  <% if @recent_machines.any? %>
                    <div class="px-3 pt-3 pb-1">
                      <small class="text-muted fw-semibold text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.05em;">Recently Used</small>
                    </div>
                    <% @recent_machines.each do |machine| %>
                    <div data-equipment-filter-target="item" data-name="<%= machine.name.downcase %>">
                      <%= button_to add_exercise_workout_path(@workout, exercise_id: @selected_exercise.id, machine_id: machine.id, to_block: @target_block&.id),
                          method: :post,
                          class: "list-group-item list-group-item-action d-flex align-items-center gap-3",
                          data: { turbo_frame: "_top" } do %>
                        <% if machine.photos.attached? %>
                          <div class="flex-shrink-0 position-relative"
                               data-controller="photo-preview"
                               data-action="click->photo-preview#show:stop"
                               data-photo-preview-urls-value='<%= machine.photos.map { |photo| url_for(photo.variant(resize_to_limit: [800, 800])) }.to_json %>'
                               style="cursor: pointer;">
                            <%= image_tag machine.photos.first.variant(resize_to_limit: [60, 60]),
                                class: "rounded",
                                style: "width: 60px; height: 60px; object-fit: cover;",
                                alt: machine.name %>
                            <% if machine.photos.count > 1 %>
                              <span class="badge badge-sm bg-dark position-absolute" style="top: 2px; left: 2px;">
                                <%= machine.photos.count %>
                              </span>
                            <% end %>
                          </div>
                        <% end %>
                        <div class="flex-grow-1">
                          <%= equipment_icon(machine.equipment_type) %>
                          <strong class="ms-2"><%= machine.name %></strong>
                          <% if machine.notes.present? %>
                            <small class="text-muted d-block ms-4"><%= truncate(machine.notes, length: 40) %></small>
                          <% end %>
                        </div>
                        <span class="badge bg-dark"><%= machine.equipment_type.humanize %></span>
                      <% end %>
                    </div>
                    <% end %>
                    <div class="px-3 pt-3 pb-1">
                      <small class="text-muted fw-semibold text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.05em;">All Equipment</small>
                    </div>
                  <% end %>

                  <% recent_ids = @recent_machines.map(&:id) %>
                  <% @machines.reject { |m| recent_ids.include?(m.id) }.each do |machine| %>
                  <div data-equipment-filter-target="item" data-name="<%= machine.name.downcase %>">
                    <%= button_to add_exercise_workout_path(@workout, exercise_id: @selected_exercise.id, machine_id: machine.id, to_block: @target_block&.id),
                        method: :post,
                        class: "list-group-item list-group-item-action d-flex align-items-center gap-3",
                        data: { turbo_frame: "_top" } do %>
                      <% if machine.photos.attached? %>
                        <div class="flex-shrink-0 position-relative"
                             data-controller="photo-preview"
                             data-action="click->photo-preview#show:stop"
                             data-photo-preview-urls-value='<%= machine.photos.map { |photo| url_for(photo.variant(resize_to_limit: [800, 800])) }.to_json %>'
                             style="cursor: pointer;">
                          <%= image_tag machine.photos.first.variant(resize_to_limit: [60, 60]),
                              class: "rounded",
                              style: "width: 60px; height: 60px; object-fit: cover;",
                              alt: machine.name %>
                          <% if machine.photos.count > 1 %>
                            <span class="badge badge-sm bg-dark position-absolute" style="top: 2px; left: 2px;">
                              <%= machine.photos.count %>
                            </span>
                          <% end %>
                        </div>
                      <% end %>
                      <div class="flex-grow-1">
                        <%= equipment_icon(machine.equipment_type) %>
                        <strong class="ms-2"><%= machine.name %></strong>
                      <% if machine.notes.present? %>
                        <small class="text-muted d-block ms-4"><%= truncate(machine.notes, length: 40) %></small>
                        <% end %>
                      </div>
                      <span class="badge bg-dark"><%= machine.equipment_type.humanize %></span>
                    <% end %>
                  </div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <!-- No equipment yet - prompt to create one -->
              <div class="p-4 text-center">
                <i class="bi bi-gear display-4 text-muted mb-3"></i>
                <h6>No equipment at <%= @workout.gym.name %> yet</h6>
                <p class="text-muted small">Add equipment to track variations of this exercise.</p>
                <%= link_to new_gym_machine_path(@workout.gym, return_to: add_exercise_workout_path(@workout, select_exercise: @selected_exercise.id, to_block: @target_block&.id)),
                    class: "btn btn-primary",
                    data: { turbo_frame: "_top" } do %>
                  <i class="bi bi-plus-lg me-1"></i>Add Equipment
                <% end %>
              </div>
            <% end %>
            
            <div class="p-3 d-flex gap-2">
              <%= link_to add_exercise_workout_path(@workout, to_block: @target_block&.id), class: "btn btn-outline-secondary btn-sm" do %>
                <i class="bi bi-arrow-left me-1"></i>Back to exercises
              <% end %>
            </div>
          <% else %>
            <!-- Step 1: Search & Select Exercise -->
            <div class="p-3 border-bottom sticky-top bg-body">
              <%= form_with url: add_exercise_workout_path(@workout, to_block: @target_block&.id), 
                  method: :get,
                  data: { controller: "search", turbo_frame: "exercise_list" } do %>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <%= text_field_tag :search, params[:search],
                      class: "form-control",
                      placeholder: "Search exercises...",
                      autocomplete: "off",
                      data: { search_target: "input", action: "input->search#search" } %>
                </div>
              <% end %>
            </div>

            <!-- Exercise List -->
            <%= turbo_frame_tag "exercise_list" do %>
              <div class="list-group list-group-flush">
                <!-- Create new exercise option -->
                <%= link_to new_exercise_path(return_to: add_exercise_workout_path(@workout, to_block: @target_block&.id)),
                    class: "list-group-item list-group-item-action text-primary",
                    data: { turbo_frame: "_top" } do %>
                  <i class="bi bi-plus-lg me-2"></i>Create new exercise...
                <% end %>
                
                <% @exercises.each do |exercise| %>
                  <!-- Always go to machine selection step -->
                  <%= link_to add_exercise_workout_path(@workout, select_exercise: exercise.id, to_block: @target_block&.id),
                      class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center",
                      data: { turbo_frame: "modal" } do %>
                    <div>
                      <strong><%= exercise.name %></strong>
                      <% if exercise.description.present? %>
                        <small class="text-muted d-block"><%= truncate(exercise.description, length: 50) %></small>
                      <% end %>
                    </div>
                    <div>
                      <% if exercise.has_weight %>
                        <span class="badge bg-secondary">Weighted</span>
                      <% end %>
                      <span class="badge bg-dark"><%= exercise.exercise_type %></span>
                      <i class="bi bi-chevron-right ms-2"></i>
                    </div>
                  <% end %>
                <% end %>

                <% if @exercises.empty? %>
                  <div class="text-center py-4 text-muted">
                    <i class="bi bi-search display-6"></i>
                    <p class="mt-2">No exercises found</p>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>
